"use client";

import React, { useMemo, useState } from "react";
import { Intervalo, apiBase, postJSON } from "../lib/api";

export type ResultadoSim = {
  banca0: number;
  banca_fin: number;
  pnl_total: number;
  roi: number;
  max_drawdown: number;
  max_racha_perdidas: number;
  max_racha_ganadas: number;
  trades: Array<{
    fin_ts_utc: string;
    patron: string;
    direccion: "V" | "R";
    real: "V" | "R";
    gano: boolean;
    pnl: number;
    banca_despues: number;
  }>;
};

export default function SimPanel({
  abierto,
  onCerrar,
  mercadoApi,
  intervalo,
  inicio,
  fin,
  patron,
  direccion,
}: {
  abierto: boolean;
  onCerrar: () => void;
  mercadoApi: string;
  intervalo: Intervalo;
  inicio: string;
  fin: string;
  patron: string | null;
  direccion: "V" | "R" | null;
}) {
  const base = apiBase();

  const [banca0, setBanca0] = useState(1000);
  const [stake, setStake] = useState(10);
  const [payout, setPayout] = useState(0.85);
  const [reinvertir, setReinvertir] = useState(true);

  const [cargando, setCargando] = useState(false);
  const [resultado, setResultado] = useState<ResultadoSim | null>(null);
  const [error, setError] = useState<string | null>(null);

  const puede = abierto && patron && direccion;

  async function simular() {
    if (!puede) return;
    setCargando(true);
    setError(null);
    setResultado(null);
    try {
      const res = await postJSON<ResultadoSim>(`${base}/simular`, {
        mercado: mercadoApi,
        intervalo,
        inicio,
        fin,
        patron,
        direccion,
        banca0,
        stake,
        payout,
        reinvertir,
      });
      setResultado(res);
    } catch (e: any) {
      setError(e?.message || "Error al simular");
    } finally {
      setCargando(false);
    }
  }

  const resumen = useMemo(() => {
    if (!resultado) return null;
    return {
      roiPct: (resultado.roi * 100).toFixed(2) + "%",
    };
  }, [resultado]);

  if (!abierto) return null;

  return (
    <div className="card">
      <div className="cardBody">
      <div style={{ display: "flex", justifyContent: "space-between", gap: 10, alignItems: "center" }}>
        <div>
          <b>Simulación (entrar en todas)</b>
          <div style={{ fontSize: 12, opacity: 0.7 }}>
            Patrón: <span style={{ fontFamily: "ui-monospace, SFMono-Regular, Menlo, monospace" }}>{patron || "-"}</span>{" "}
            | Dir: {direccion || "-"}
          </div>
        </div>
        <button onClick={onCerrar} >
          Cerrar
        </button>
      </div>

      <div className="grid grid4" style={{ marginTop: 12 }}>
        <div>
          <div style={{ fontSize: 12, opacity: 0.7 }}>Banca inicial</div>
          <input type="number" value={banca0} onChange={(e) => setBanca0(Number(e.target.value))}  />
        </div>
        <div>
          <div style={{ fontSize: 12, opacity: 0.7 }}>Stake por entrada</div>
          <input type="number" value={stake} onChange={(e) => setStake(Number(e.target.value))}  />
        </div>
        <div>
          <div style={{ fontSize: 12, opacity: 0.7 }}>Payout</div>
          <input type="number" step="0.01" value={payout} onChange={(e) => setPayout(Number(e.target.value))}  />
        </div>
        <div style={{ display: "flex", alignItems: "flex-end" }}>
          <label style={{ display: "flex", gap: 8, alignItems: "center", fontSize: 13 }}>
            <input type="checkbox" checked={reinvertir} onChange={(e) => setReinvertir(e.target.checked)} />
            Reinvertir (la banca se actualiza)
          </label>
        </div>
      </div>

      <div style={{ display: "flex", gap: 10, marginTop: 12, flexWrap: "wrap" }}>
        <button
          onClick={simular}
          disabled={!puede || cargando}
          className="btnPrimary"
        >
          {cargando ? "Simulando..." : "Correr simulación"}
        </button>
        {error && <div style={{ color: "crimson", fontSize: 13 }}>{error}</div>}
      </div>

      {resultado && (
        <div style={{ marginTop: 12 }}>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(4, minmax(0, 1fr))", gap: 10 }}>
            <div style={{ border: "1px solid #eee", borderRadius: 12, padding: 10 }}>
              <div style={{ fontSize: 12, opacity: 0.7 }}>Banca final</div>
              <b>{resultado.banca_fin.toFixed(2)}</b>
            </div>
            <div style={{ border: "1px solid #eee", borderRadius: 12, padding: 10 }}>
              <div style={{ fontSize: 12, opacity: 0.7 }}>PnL</div>
              <b>{resultado.pnl_total.toFixed(2)}</b>
            </div>
            <div style={{ border: "1px solid #eee", borderRadius: 12, padding: 10 }}>
              <div style={{ fontSize: 12, opacity: 0.7 }}>ROI</div>
              <b>{resumen?.roiPct}</b>
            </div>
            <div style={{ border: "1px solid #eee", borderRadius: 12, padding: 10 }}>
              <div style={{ fontSize: 12, opacity: 0.7 }}>Max drawdown</div>
              <b>{resultado.max_drawdown.toFixed(2)}</b>
            </div>
          </div>

          <div style={{ marginTop: 12, fontSize: 12, opacity: 0.7 }}>
            Trades: {resultado.trades.length} | Máx racha pérdidas: {resultado.max_racha_perdidas} | Máx racha ganadas: {resultado.max_racha_ganadas}
          </div>
        </div>
      )}
      </div>
    </div>
  );
}
