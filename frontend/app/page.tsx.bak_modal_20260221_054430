"use client";

import React, { useMemo, useState } from "react";
import Controls, { Controles } from "./components/Controls";
import RankTable, { FilaPatron } from "./components/RankTable";
import SimPanel from "./components/SimPanel";
import ComparePanel from "./components/ComparePanel";
import { apiBase, postJSON, Intervalo } from "./lib/api";

function isoAhoraMenosDias(dias: number) {
  const d = new Date(Date.now() - dias * 24 * 60 * 60 * 1000);
  return d.toISOString();
}

function isoAhora() {
  return new Date().toISOString();
}

export default function Page() {
  const base = apiBase();

  const [controles, setControles] = useState<Controles>({
    mercadoUI: "BTC",
    mercadoApi: "btc-updown",
    intervalo: "5m",
    inicio: isoAhoraMenosDias(7),
    fin: isoAhora(),
    usarUltimo: false,
    longitudMax: 6,
    minMuestras: 20,
    suavizado: 1.0,
  });

  const [filas, setFilas] = useState<FilaPatron[]>([]);
  const [cargando, setCargando] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [simAbierto, setSimAbierto] = useState(false);
  const [simPatron, setSimPatron] = useState<string | null>(null);
  const [simDir, setSimDir] = useState<"V" | "R" | null>(null);

  const [compAbierto, setCompAbierto] = useState(false);
  const [compPatron, setCompPatron] = useState<string | null>(null);
  const [compDir, setCompDir] = useState<"V" | "R" | null>(null);

  async function rankear() {
    setCargando(true);
    setError(null);
    try {
      const res = await postJSON<{ filas: FilaPatron[] }>(`${base}/patrones/rankear`, {
        mercado: controles.mercadoApi,
        intervalo: controles.intervalo,
        inicio: controles.inicio,
        fin: controles.fin,
        longitud_max: controles.longitudMax,
        min_muestras: controles.minMuestras,
        suavizado: controles.suavizado,
      });
      setFilas(res.filas || []);
    } catch (e: any) {
      setError(e?.message || "Error al rankear");
      setFilas([]);
    } finally {
      setCargando(false);
    }
  }

  const header = useMemo(() => {
    return (
      <div style={{ display: "flex", justifyContent: "space-between", gap: 10, alignItems: "baseline", flexWrap: "wrap" }}>
        <div>
          <h1 className="h1">PolyPatron</h1>
          <div className="small">
            Analiza patrones V/R en mercados binarios (hist칩rico + simulaci칩n).
          </div>
        </div>
        <div className="small">
          API: {base}
        </div>
      </div>
    );
  }, [base]);

  return (
    <div className="container">
      {header}

      <div style={{ marginTop: 14 }}>
        <Controls
          value={controles}
          onChange={setControles}
          onRankear={rankear}
          onComparar={() => setCompAbierto(true)}
          cargando={cargando}
        />
      </div>

      {error && <div style={{ marginTop: 10, color: "crimson" }}>{error}</div>}

      <div style={{ marginTop: 14 }}>
        <RankTable
          filas={filas}
          onSimular={(p, d) => {
            setSimPatron(p);
            setSimDir(d);
            setSimAbierto(true);
          }}
          onElegirParaComparar={(p, d) => {
            setCompPatron(p);
            setCompDir(d);
            setCompAbierto(true);
          }}
        />
      </div>

      <div style={{ marginTop: 14 }}>
        <SimPanel
          abierto={simAbierto}
          onCerrar={() => setSimAbierto(false)}
          mercadoApi={controles.mercadoApi}
          intervalo={controles.intervalo as Intervalo}
          inicio={controles.inicio}
          fin={controles.fin}
          patron={simPatron}
          direccion={simDir}
        />
      </div>

      <div style={{ marginTop: 14 }}>
        <ComparePanel
          abierto={compAbierto}
          onCerrar={() => setCompAbierto(false)}
          mercadoApi={controles.mercadoApi}
          intervalo={controles.intervalo as Intervalo}
          fin={controles.fin}
          patronInicial={compPatron}
          direccionInicial={compDir}
        />
      </div>

      <div style={{ marginTop: 22, fontSize: 12, opacity: 0.7 }}>
        Nota: Este programa analiza hist칩rico. No da se침ales en vivo ni garantiza resultados futuros.
      </div>
    </div>
  );
}
